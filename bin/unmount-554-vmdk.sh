#!/bin/sh
#
# This script creates vShieldEdge VM using the GOLD VM and the image file image-edge-edge.img.dist
# generated by ./doit.edge
#

set -ue

##
# Commands/Utilities used for OVF creation
##
TCROOT=/build/toolchain
MOUNT=$TCROOT/lin32/util-linux-ng-2.15/bin/mount
UMOUNT=$TCROOT/lin32/util-linux-ng-2.15/bin/umount
RM=$TCROOT/lin32/coreutils-6.12/bin/rm
CP=$TCROOT/lin32/coreutils-6.12/bin/cp
MKDIR=$TCROOT/lin32/coreutils-6.12/bin/mkdir
LN=$TCROOT/lin32/coreutils-6.12/bin/ln
LS=$TCROOT/lin32/coreutils-6.12/bin/ls
TAR=$TCROOT/lin32/tar-1.20/bin/tar
RENAME=$TCROOT/lin32/util-linux-2.13_pre7/usr/bin/rename
CAT=$TCROOT/lin32/coreutils-6.12/bin/cat
OVFTOOL_LD_LIBRARY_PATH=$TCROOT/lin64/libxml2-2.9.1/lib/
OVFTOOL=$TCROOT/lin64/ovftool-3.0.1-1/ovftool
SHA1SUM=$TCROOT/lin32/coreutils-6.12/bin/sha1sum
SED=$TCROOT/lin32/sed-4.1.5/bin/sed
CUT=$TCROOT/lin32/coreutils-6.12/bin/cut
PATCH=$TCROOT/lin32/patch-2.5.9/bin/patch
CHMOD=$TCROOT/lin32/coreutils-6.12/bin/chmod
CHOWN=$TCROOT/lin32/coreutils-6.12/bin/chown
GZIP=$TCROOT/lin32/gzip-1.3.5/bin/gzip
ZIP=$TCROOT/lin32/zip-3.0/bin/zip
STRIP=$TCROOT/lin32/binutils-2.17/x86_64-linux/bin/strip
FDISK=$TCROOT/lin64/util-linux-ng-2.15/sbin/fdisk
INSTALL=$TCROOT/lin32/coreutils-6.12/bin/install

TOPDIR=`pwd`
MNTDIR="$TOPDIR/mnt"

unmount_554_vmdk()
{
   echo "Unmounting the VMDK..."

   if mountpoint -q $MNTDIR/var/log; then
      $UMOUNT -d $MNTDIR/var/log
   fi

   if mountpoint -q $MNTDIR; then
      $UMOUNT -d $MNTDIR
   fi
}

unmount_554_vmdk
$RM -rf $MNTDIR
